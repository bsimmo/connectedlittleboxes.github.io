<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html>
<!--<![endif]-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="description" content="Connected Little Boxes Device Setup">

  <meta name="author" content="Rob Miles">

  <title>Connected Little Boxes Device Setup</title>

  <!-- Mobile Specific Meta
  ================================================== -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.png" />

  <!-- CSS
  ================================================== -->
  <!-- Themefisher Icon font -->
  <link rel="stylesheet" href="plugins/themefisher-font/style.css">
  <!-- bootstrap.min css -->
  <link rel="stylesheet" href="plugins/bootstrap/css/bootstrap.min.css">
  <!-- Lightbox.min css -->
  <link rel="stylesheet" href="plugins/lightbox2/dist/css/lightbox.min.css">
  <!-- animation css -->
  <link rel="stylesheet" href="plugins/animate/animate.css">
  <!-- Slick Carousel -->
  <link rel="stylesheet" href="plugins/slick/slick.css">
  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="css/style.css">

</head>

<body id="body">

  <!--
  Start Preloader
  ==================================== -->
  <div id="preloader">
    <div class='preloader'>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  <!--
  End Preloader
  ==================================== -->

  <!--
Fixed Navigation
==================================== -->
  <header class="navigation fixed-top">
    <div class="container">
      <!-- main nav -->
      <nav class="navbar navbar-expand-lg navbar-light">
        <!-- logo -->
        <a class="navbar-brand logo" href="index.html">
          <img class="logo-default" src="images/logo.png" alt="logo" />
          <img class="logo-white" src="images/logo-white.png" alt="logo" />
        </a>
        <!-- /logo -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navigation">
          <ul class="navbar-nav ml-auto text-center">
            <li class="nav-item ">
              <a class="nav-link" href="overview.html">Overview</a>
            </li>
            <li class="nav-item dropdown ">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                Documentation
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="gettingstarted.html">Getting Started</a>
                <a class="dropdown-item" href="hardware.html">Hardware</a>
                <a class="dropdown-item" href="software.html">Box Software</a>
                <a class="dropdown-item" href="server.html">Server Software</a>
              </div>
            </li>
            <li class="nav-item ">
              <a class="nav-link" href="news.html">News</a>
            </li>
            <li class="nav-item ">
              <a class="nav-link" href="nameinlights.html">Name in lights</a>
            </li>
            <li class="nav-item ">
              <a class="nav-link" href="contact.html">Contact</a>
            </li>
          </ul>
        </div>
      </nav>
      <!-- /main nav -->
    </div>
  </header>
  <!--
End Fixed Navigation
==================================== -->


  <section class="single-page-header">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h2>Device Setup</h2>
        </div>
      </div>
    </div>
  </section>


  <section class="about-shot-info section-sm">
    <div class="container">
      <div class="row">
        <div class="col-md-6 mt-20">
          <h2>Choose your Browser</h2>
          <p>The download process uses browser features that are only available on the Chromium platform. If you are not
            using such a browser (Google Chrome and Microsoft Edge are the most popular ones) you will need to
            install one. </p>
          <p>I'm a big fan of Microsoft Edge which you can get <a href="https://www.microsoft.com/en-us/edge">here.</a>
          </p>
        </div>
        <div class="col-md-6">
          <img class="img-fluid" src="images/esptool/edge.jpg" alt="">
        </div>
      </div>
    </div>
  </section>

  <section class="about-shot-info section-sm bg-gray">
    <div class="container">
      <div class="row">
        <div class="col-md-6 mt-20">
          <h2>Plug in your Device</h2>
          <p>You'll need a usb cable to connect your device to your computer. When you plug it the computer should
            recognise it automatically and install the drivers.
            If it doesn't you may have to install them by hand. </p>
          <p>In Windows you can check in Device Manager to make sure that the device is working OK. Click
            the Windows Start button and search for 'Device' and then select the Device Manager from the menu. If all is
            well you should
            see your device as shown on the right.
            </a>.
            </a> </p>
        </div>
        <div class="col-md-6">
          <img class="img-fluid" src="images/esptool/device manager.png" alt="">
        </div>
      </div>
    </div>
  </section>

  <section class="about-shot-info section-sm">
    <div class="container">
      <div class="row">
        <div class="col-md-6 mt-20">
          <h2>Get connected</h2>
          <p>Next, you need to connect your device to the browser. Press the Connect Device button below when you are
            ready.</p>
          <p>
            <button class="menuButton" onclick="doConnect();">Connect Device</button>
          </p>
          <p>A dialog box like the one on the right will pop up inviting you to select a device to program.</p>
          <p>I'm using a device connected to COM5. The number will vary, depending on which socket you plug the device
            into.
            If you are not using Windows 10 the ports won't have a number, instead there might be some strange names.
            You can try each one in turn, reloading the page between attempts.
            If the name includes the word 'Bluetooth' then I don't think it will work.</p>
          <p>When you have selected the port you want to use, press the Connect button in the dialog to connect. Then move down to the next stage. </p>
        </div>
        <div class="col-md-6">
          <img class="img-fluid" src="images/esptool/Connect dialogue.png" alt="">
        </div>
      </div>
    </div>
  </section>

  <section class="about-shot-info section-sm bg-gray">
    <div class="container">
      <div class="row">
        <div class="col-md-6 mt-20">
          <h2>Start the Setup</h2>
          <p>Now that you are connected you can start the process. Press the Flash button when you are ready.</p>
          <p>
            <button class="menuButton" onclick="doFlash();">Flash</button>
          </p>
          <p>Note that this will take a while. The log window will show the progress.</p>
          <p>If the process stops at the 'sync' part this might be because your device has not reset.
            You can try pressing the reset button on your device, reloading this page in your browser and trying again.
          </p>
          <p>We've not tested the process with every possible ESP device, and some don't respond to our reset signals.
            However, if you are using a Wemos device
            it should just work.
          </p>
        </div>
        <div class="col-md-6">
          <h2>Log Window</h2>
          <textarea class="logOutput" rows="15" cols="60" id="logOutput"></textarea>
        </div>
      </div>
    </div>
  </section>

  <section class="about-shot-info section-sm ">
    <div class="container">
      <div class="row">
        <div class="col-md-6 mt-20">
          <h2>Talk to your device</h2>
          <p>Now that you have your own Connected Little Box, it's time to have a chat with it. Press the Chat button below</p>
          <p>
            <button class="menuButton" onclick="doTerminal();">Chat</button>
          </p>
          <p>Note that this will take a while. The window on the right should show the progress.</p>
          <p>If the terminal stops at the 'sync' part of the process this might be because your device has not reset.
            You can try pressing the reset button on your device, reloading this page in your browser and trying again.
          </p>
          <p>We've not tested the process with every possible ESP device, and some don't respond to our reset signals.
            However, if you are using a Wemos device
            it should just work.
          </p>
        </div>
        <div class="col-md-6">
          <h2>Terminal Window</h2>
          <textarea class="logOutput" rows="20" cols="60" id="terminal" onkeypress="doKeyPress();""></textarea>
        </div>
      </div>
    </div>
  </section>



  <footer id="footer" class="bg-one">
    <div class="top-footer">
      <div class="container">
        <div class="row">
          <div class="col-sm-3 col-md-3 col-lg-3">
            <h3>about</h3>
            <p>Connected Little Boxes are a community outreach project from Connected Humber CIC.</p>
          </div>
          <!-- End of .col-sm-3 -->
          <div class="col-sm-3 col-md-3 col-lg-3">
            <ul>
              <li>
                <h3>Quick Links</h3>
              </li>
              <li><a href="https://github.com/connected-little-boxes">Connected Little Boxes on GitHub </a></li>
              <li><a href="https://mattermost.connectedhumber.org/default/channels/connected-little-boxes">Connected
                  Little Boxes on MatterMost</a>
              </li>
              <li><a href="mailto:connectedlittleboxes@robmiles.com">email us</a>
              </li>
            </ul>
          </div>
          <!-- End of .col-sm-3 -->
        </div>
      </div> <!-- end container -->
    </div>
    <div class="footer-bottom">
      <h5>Copyright 2021. All rights reserved.</h5>
    </div>
  </footer> <!-- end footer -->

  <!-- end Footer Area
    ========================================== -->



  <!-- 
    Essential Scripts
    =====================================-->
  <!-- Main jQuery -->
  <script src="plugins/jquery/jquery.min.js"></script>

  <!-- Form Validation -->
  <script src="plugins/form-validation/jquery.form.js"></script>
  <script src="plugins/form-validation/jquery.validate.min.js"></script>

  <!-- Bootstrap4 -->
  <script src="plugins/bootstrap/js/bootstrap.min.js"></script>
  <!-- Parallax -->
  <script src="plugins/parallax/jquery.parallax-1.1.3.js"></script>
  <!-- lightbox -->
  <script src="plugins/lightbox2/dist/js/lightbox.min.js"></script>
  <!-- Owl Carousel -->
  <script src="plugins/slick/slick.min.js"></script>
  <!-- filter -->
  <script src="plugins/filterizr/jquery.filterizr.min.js"></script>
  <!-- Smooth Scroll js -->
  <script src="plugins/smooth-scroll/smooth-scroll.min.js"></script>

  <script src="js/esptool/ESPManager.js"></script>
  <script src="js/esptool/ESPToolJS.js"></script>
  <script src="js/esptool/ESP32.js"></script>
  <script src="js/esptool/ESP8266.js"></script>
  <script src="js/esptool/SerialManager.js"></script>
  <script src="js/esptool/stubs.js"></script>

  <!-- Custom js -->
  <script src="js/script.js"></script>

  <!-- esptool functions -->
  <script>

    var device = null;
    var connected = false;

    function addLineToLog(message) {
      let output = document.getElementById('logOutput');
      output.value = output.value + message + '\n';
      output.scrollTop = output.scrollHeight;
    }

      function addTextToTerminal(text) {
        let output = document.getElementById('terminal');
        output.value = output.value + text;
        output.scrollTop = output.scrollHeight;
      }

    async function connect()
    {
      console.log("Connecting..");

      if (device === null) {
        device = new ESPManager(addLineToLog);
      }

      let { worked, message } = await device.connect();

      if (!worked) {
        alert(message);
        return false;
      }
      else {
        connected = true;
        return true;
      }
    }

    async function doFlash() {

      // Automatically connect if we have not been connected already

      if (!connected) {
        let result = await connect();
        if(!result){
          return;
        }
      }

      console.log("Flashing..");

      let { worked, message } = await device.flashDevice();

      console.log(message);

      if (!worked) {
        alert(message);
      }
    }

    async function doConnect() {
      connect();
    }

    async function doTerminal(){

      console.log("Starting terminal..");

      if (!connected) {
        let result = await connect();
        if(!result){
          return;
        }
      }

      await device.startTerminal(addTextToTerminal);
    }

    async function doKeyPress(){
        var key = window.event.keyCode;
        await device.writeUint8ToTerminal(key);
        return false;
    }

  </script>

</body>

</html>